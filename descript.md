# BlockChain

#### Block

블록체인을 구성하는 각각의 블록을 의미한다.

블록은 **블록헤더**, **거래정보**, **기타정보**로 구성된다.


#### 블록 헤더

6가지의 바이트 형식의 직렬화된 데이터를 포함한다.

- version : 블록 버전 번호를 나타낸다. GolockChain에는 구현되어있지 않다.
- merkle hash : 블록의 유일성을 표시하는 SHA256으로 해싱된 데이터를 말한다. GolockChain의 `Hash` 가 이 역할을 한다.
- previous blockhash : 이전 블록의 merkle hash를 표시한다. GolockChain의 `PrevBlockHash` 가 이 역할을 한다.
- time : 채굴자가 블록을 생성한 시간을 표시한다. 이 시간 데이터는 이전 블록보다 반드시 커야한다. GolockChain의 `Timestamp` 가 이 역할을 한다.
- bits : 블록을 생성하는데 요구되는 생성 조건을 표시한다. 좀 더 쉽게 설명하면 생성되는 블록의 merkle hash데이터는 반드시 bits 데이터의 크기 보다 작아야하는데, 랜덤으로 생성된 merkle hash 데이터가 bits보다 클 경우 해당 merkle hash값은 무효화 되며 다시 계산되어야한다. GolockChain에서 `Target` 이 이 역할을 한다.
- nonce : merkls hash가 유효하다고 판단될 때까지 반복된 계산 횟수를 말한다. GolockChain에서 `nonce`가 이 역할을 한다.



#### 거래

Transaction, 입력과 출력으로 구성된다.

거래의 입력값은, 이전 거래의 출력값의 형태로 구성된다.

#### 순서

***1. 거래생성 - Person A 가 Person B에게 1gogocoin을 주는 거래가 생성됨.***

- 여기서 1gogocoin을 전송했다는 `의사표현`을 한 것일뿐  실제로 거래를 통한 가치 이동이 이루어지지는 않았다.

***2. 거래서명 - 거래가 생성되어 이 거래가 성사되기 위한 서명이 필요함***

- Person A가 거래를 생성했다고 해서 반드시 서명까지 Person A가 해야할 필요는 없다. 서명은 무조건 자금원의 소유자가 한다.
- 서명이 완료되면, 비트코인 거래에 필요한 정보가 담겨있는 `거래정보` 가 생겨난다.

***3. 거래정보 전송 - 거래정보는 Person A, Person B 둘만 알고 있다고 해서 거래가 성사되는 것이 아니다.***

- `Person A가 Person B에게 1 gogocoin을 전송한다.`는 거래정보는 코인 네트워크를 구성하는 하나의 노드에 전송되어야한다.
- 거래정보를 신뢰할 수 없는 노드에 보내도 상관없는 이유는 3가지가 있다.
  - 단순히 `Person A가 Person B에게 1 gogocoin 전송` 이라는 스크립트가 업로드될 뿐이다. 그리고 이 마저도 `암호화(hashing)` 되어 전송된다.
  - 개인키, 인증서, 비밀정보등을 포함하지 않는다. 그러므로 공개적인 전송이 가능하다. 그래서 우리의 거래정보가 수많은 네트워크들 중 어느 노드에 전달된다 하더라도(설령 그것이 공개가 된다고 하더라도) 문제될 것이 없다.
  - 코인의 소비자, 채굴자 모두 해킹등의 부정한 방법을 이용해 코인을 획득하게 됨이 외부에 알려지게 된다면, 그 자체만으로 코인의 가치가 폭락하게 된다. 부정한 방법을 이용하는 것 자체가 자신의 재산적 손실을 불러일으킨다.

***4. 거래정보 전파 - 거래정보가 하나의 노드에 전달되면 이 노드는 네트워크상에 존재하는 모든 노드에 해당 거래정보를 전파한다.***

- 일반적으로 코인 네트워크는 P2P 기반으로 운영되기 때문에 모든 노드가 동등한 지위를 갖고 있다.
- 거래정보 하나는 수 천개의 노드에 전파하는데 불과 몇 초 걸리지 않는다.
- 이렇게 거래정보를 전달 받은 노드들이 `작업증명`을 통해 블록을 생성하려고 노력한다.

***5. 거래완료***

- 이 중 가장 빠르게 작업을 마치고 블록을 생성한 노드가 자신이 만든 블록에 거래정보를 기록하고, 그 노드는 보상으로 코인을 수령하게 된다.



#### 실제 코인이 이동하는 과정

여러 PIN-tech 서비스를 이용하다보면 **전송해야할 금액, 누구에게로 송금할지 여부(입력값)** 과 받는 이에게 **계좌에 들어온 금액(출력값)**이 찍히고서 거래가 이루어진다. 실제 코인거래도 이와 비슷하게 이루어진다.



몇 gogocoin을 보낼지 입력하는 입력값을 넣고, 전송할 지갑 주소를 입력하면 해당 값이 대응되는 지갑 주소에 출력값이 찍히게 된다. 이 출력값에는 실제로 지갑의 소유자가 갖게될 코인과 해당 거래정보에 대한 블록을 생성한 채굴자의 수수료가 포함된다.



####  UTXO(Unspent Transaction Output)

UTXO는 `사용되지 않은 거래출력`이라고 할 수 있다.

코인 거래에 가장 중요한 부분인 UTXO는 잔액계산 시스템과 얼추 비슷하다. 

- Person A에게 [1 gogocoin], [9 gogocoin], [2 gogocoin] 총 3개의 UTXO가 있다고 가정한다.
- Person B에게 [8 gogocoin]을 전송하려고한다.
- Person A가 갖고 있는 3개의 UTXO중에서 8보다 높은 9 gogocoin을 참조해서 입력값으로 전송한다. 
- 9 gogocoin을 총액을 전송한 다음 출력값에서 8 gogocoin, 1 gogocoin으로 나눈다.
- 1 gogocoin을 Person A에게 입력값으로 되돌려준다.
- 만약 보유하고 있는 UTXO 중 가장 큰 값보다 큰 gogocoin을 전송하려고 하면 전송에 실패한다.